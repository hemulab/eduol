//图形验证码
var refreshCaptcha = function () {
    $.get('/site/captcha', {'refresh': 1}, function (data) {
        $('#mobile-captcha').attr('src', data.url);
    });
};
refreshCaptcha();
$('#mobile-captcha').on('click', function () {
    refreshCaptcha();
});
var wait_checkcode = false; // 等待验证码失效
$('.send-code').on('click', function (evt) {
    evt.preventDefault();
    mobile = $('input[name=mobile]').val();
    verifyCode = $('input[name=verifyCode]').val();
    if (!mobile) {
        showTips('请填写正确的手机号！');
        return false;
    }
    if (!validateMobile(mobile)) {
        showTips('请填写正确的手机号！');
        return false;
    }
    if (!verifyCode) {
        showTips('请填写图形验证码');
        return false;
    }
    if (wait_checkcode) return false;
    $el = $(this);
    wait_checkcode = true;
    data = {
        verifyCode: verifyCode,
        account: mobile,
        'do': 4,
        type: 'mobile'
    }
    $el.html('正在发送...');
    $.get(this.href, data, 'json')
        .done(function (res) {
            if (res.errcode == 1) {
                showTips(res.message);
                $el.html('获取验证码');
                wait_checkcode = false;
                refreshCaptcha();
                return false;
            }
            self.sended = true; // 验证码获取成功
            var seconds = 60;
            var start = function () {
                seconds--;
                if (seconds == 0) {
                    wait_checkcode = false;
                    if (_t) clearInterval(_t);
                    $el.html('获取验证码');
                    return;
                }
                $el.html('<strong>' + seconds + '</strong>秒后重新获取');
            };
            start();
            var _t = setInterval(start, 1000);
        })
        .fail(function () {
            $el.html('获取验证码');
            wait_checkcode = false;
            alert('验证码获取失败，请重新获取!');
        });
    return false;
})

$('#bind').on('click', function (evt) {
    evt.preventDefault();
    mobile = $('input[name=mobile]').val();
    code = $('input[name=code]').val();
    username = $('#user-name').val();
    password = $('#user-pwd').val();
    jump_url = $('input[name=jump_url]').val();
    if (!username) {
        alert('请填写用户名');
        return false;
    }
    if (!password) {
        alert('请填写密码！');
        return false;
    }
    if (!mobile) {
        showTips('请填写正确的手机号！');
        return false;
    }
    if (!validateMobile(mobile)) {
        showTips('请填写正确的手机号！');
        return false;
    }
    if (!code) {
        showTips('请填写短信验证码');
        return false;
    }
    data = {
        mobile: mobile,
        code: code,
        password: password,
        username: username,
        jump_url: jump_url,
        bind: 2,
        _csrf: $('input[name="_csrf"]').val()
    }
    $.post('/site/mobile-bind', data, 'json').done(function (res) {
        if (res.errcode == 0) {
            $('#bindForm').hide();
            $('#loginForm').hide();
            $('#show').show();
        } else {
            showTips(res.message);
        }
    }).fail();
});
validateMobile = function (val) {
    return /^\d{11}$/.test(val);
}

laydirect = function (url, mobile, message) {
    layer.open({
        type: 1
        ,
        title: false //不显示标题栏
        ,
        closeBtn: false
        ,
        area: ['400px', '200px']
        ,
        shade: 0.4
        ,
        id: 'LAY_layuipro' //设定一个id，防止重复弹出
        ,
        resize: false
        ,
        btnAlign: 'c'
        ,
        moveType: 1 //拖拽模式，0或者1
        ,
        content: '<div style="padding: 50px; padding-left:100px; line-height: 22px; background: #f9fafd url(static/images/gou.gif) no-repeat; background-position: 45px 52px; color: black; font-weight: 300;"><h1>' + message + '</h1>你可以使用手机号' + mobile + '登录该账户<br><br><a href="http://passport.21cnjy.com">2秒后自动跳转，未跳转请点击这里</a></div>'
        ,
        success: function (layero) {

            $('#layui-layer2').css({'border-radius': '5px', "overflow": 'hidden'});
            var seconds = 2;
            var start = function () {
                seconds--;
                if (seconds == 0) {
                    window.location = url;
                }
            };
            start();
            var _t = setInterval(start, 1000);
        }
    });
}

showTips = function (tips) {
    $('#errorcode').css({'display': 'block', 'margin-bottom': '-10px', 'margin-top': '10px'});
    $('#errorcode').html(tips);
}





