var Task = {
    model: {
        isinvoice: 0,
        rmb: 0,
        buy_xd: 0,
        buy_xk: 0,
        default_invoice: 0,
        order_url: "",
        isactive: 1,
        coupon_info: 0,
        coupon_price: 0,
        coupon_id: 0,
        tc: 0,
        invoice: function () {
            return this.isinvoice && Task.invoice.data.elec ? 0 : this.isinvoice ? this.default_invoice : 0
        }
    }, count_total: function () {
        var i = this.model.isinvoice, t = $("#coupon-checkbox").val(), e = $("#coupon-checkbox").attr("val"),
            o = this.model.rmb + this.model.invoice();
        $("#coupon-checkbox").is(":checked") ? (this.model.coupon_price = 1 == this.model.coupon_info.type ? parseFloat(t) : o * (parseFloat(t) / 100), this.model.coupon_id = e) : (this.model.coupon_price = 0, this.model.coupon_id = 0), o -= 0 == this.model.rmb ? 0 : this.model.coupon_price, $(".pay-total").find("#msg-change").html([i ? "（套餐+发票）" : ""]), $(".pay-total").find(".play-big").html(o.toFixed(2)), this.model.coupon_price > 0 ? $(".pay-total").find(".discount").html("（优惠卷抵扣" + this.model.coupon_price + "元） ") : $(".pay-total").find(".discount").html("")
    }, init: function (i) {
        this.event = $({}), $.extend(this.model, i), this.init_xk(), this.init_taocan(), this.coupon(), this.invoice.init(), this.submit_order()
    }, init_xk: function () {
        var i = [], t = this;
        $(".custom-select-enable").each(function () {
            var e = this;
            i.push(this);
            $(e).hasClass("xd-select");
            $(this).on("click", function () {
                $.each(i, function (i, t) {
                    var o = t !== e;
                    $(t).find(".sel-list")[o ? "hide" : "show"]()
                }), $(this).addClass("sel-active")
            }), t.event.on("select-error", function (i, t, o) {
                $(e).hasClass(o) && ($(e)[t ? "removeClass" : "addClass"]("error"), $(".warn")[t ? "hide" : "show"]())
            }), $(document.body).on("click", function (i) {
                var t = $(i.target);
                t.hasClass("custom-select-enable") || 0 != t.parents(".custom-select-enable").length || ($(e).find(".sel-list").hide(), $(e).removeClass("sel-active"))
            }), $(this).on("click", ".sel-list li", function (i) {
                i.stopPropagation();
                var o = $(this).html(), n = $(this).data("id"), a = $(e).find("input[type=hidden]");
                $(e).find("span.selet-txt").html(o), a.val(n), t.model[a.attr("name")] = n, t.validate(), $(".custom-select-enable .sel-list").hide(), $(e).removeClass("sel-active")
            })
        })
    }, init_taocan: function () {
        var i = this, t = $(".pay-time li");
        $(".pay-time").find("li:first").addClass("vip-active"), t.click(function () {
            var e = $(this).find("input");
            t.removeClass("vip-active"), $(this).addClass("vip-active"), e.prop("checked", !0), i.model.tc = e.val(), i.model.rmb = e.data("money");
            var o = '<span class="pay-tit">优惠券：</span>';
            $.get("/payment/ajax-coupon", {page: 1, range: i.model.tc, is_one: 1}).done(function (t) {
                var e = t.data;
                if (500 == e) o += '<span class="coupon-null">暂无可用的优惠券</span>'; else {
                    i.model.coupon_info = e;
                    var n = 1 == e.type ? "￥" : "-", a = 1 == e.type ? e.price : e.price + "%",
                        c = "1,3,6,12" == e.range ? "全部" : e.range + "月";
                    o += '<input type="checkbox" checked="true" name="coupon_id" val="' + e.id + '" value="' + e.price + '" id="coupon-checkbox" class="f-fl" style="margin-top:12px;" />', o += '<div class="ticket__cn f-fl f-cb" id="j-coupon">\n                                <div class="ticket-text"><h3>购买' + c + "套餐使用</h3>\n                                <p>" + e.useful_starttime + "-" + e.useful_endtime + '</p></div>\n                                <div class="ticket-price"><span class="ticket-symbol">' + n + "</span>" + a + '</div></div>\n                                <span class="friendly">点击图片进行切换可使用的优惠券</span>'
                }
                $(".tip-coupon").html(o), i.count_total()
            }).fail(function () {
            })
        }), t.first().click()
    }, coupon: function () {
        var i = this, t = null;
        $("body").on("click", "#j-coupon", function () {
            $.get("/payment/ajax-coupon", {page: 1, range: i.model.tc}).done(function (i) {
                $(".ticket-pop").html(i.html).show(), t = i.info
            }).fail(function () {
            }), $(".modal-bg").show()
        }), $("body").on("click", ".ticket-close", function () {
            $(".ticket-pop").hide(), $(".modal-bg").hide()
        }), $("body").on("click", ".ticket__item", function () {
            $(".ticket-pop").hide(), $(".modal-bg").hide();
            var e = $(this).attr("val"), o = $(this).attr("price"), n = $("#coupon-checkbox");
            n.val(o), n.attr({val: e, checked: !0}), i.model.coupon_info = t[e];
            var a = i.model.coupon_info, c = 1 == a.type ? "￥" : "-", o = 1 == a.type ? a.price : a.price + "%",
                s = "1,3,6,12" == a.range ? "全部" : a.range + "月", l = '<span class="pay-tit">优惠券：</span>';
            l += '<input type="checkbox" checked="true" name="coupon_id" val="' + a.id + '" value="' + a.price + '" id="coupon-checkbox" class="f-fl" style="margin-top:12px;" />', l += '<div class="ticket__cn f-fl f-cb" id="j-coupon">\n            <div class="ticket-text"><h3>购买' + s + "套餐使用</h3>\n            <p>" + a.useful_starttime + "-" + a.useful_endtime + '</p></div>\n            <div class="ticket-price"><span class="ticket-symbol">' + c + "</span>" + o + '</div></div>\n            <span class="friendly">点击图片进行切换可使用的优惠券</span>', $(".tip-coupon").html(l), i.count_total()
        }), $("body").on("click", ".page a", function (t) {
            if (t.preventDefault(), $(this).hasClass("current")) return !1;
            var e = $(this).data("page");
            $.get("/payment/ajax-coupon", {page: e, range: i.model.tc}).done(function (t) {
                $(".ticket-pop").html(t.html), i.model.coupon_info = t.info
            }).fail(function () {
            })
        }), $("body").on("click", "#coupon-checkbox", function () {
            i.count_total()
        })
    }, validate: function () {
        var i = !0;
        return this.model.buy_xd || (i = !1), this.event.trigger("select-error", [i, "xd-select"]), this.model.buy_xk || (i = !1), this.event.trigger("select-error", [i, "xk-select"]), i
    }, getData: function () {
        var i = {
            isinvoice: this.model.isinvoice,
            rmb: this.model.rmb,
            buy_xd: this.model.buy_xd,
            buy_xk: this.model.buy_xk,
            coupon_id: 0 == this.model.rmb ? 0 : this.model.coupon_id,
            tc: this.model.tc
        }, t = $.extend({}, this.invoice.data, i);
        return delete t.isFilled, t
    }, submit_order: function () {
        var i = this;
        void 0 === this._ajax_submit && (this._ajax_submit = !1), $(".pay-form").on("submit", function (t) {
            return void 0 === USER.uid ? (OT2.Global.initLogin(), !1) : $("#clause-checkbox").prop("checked") ? (t.preventDefault(), !i._ajax_submit && (!!i.validate() && (i._ajax_submit = !0, $("#btn_order", this).html("提交中"), void $.post(i.model.order_url, i.getData(), "json").done(function (i) {
                1 == i.errorcode ? $(".pay-fail").show().html(i.message) : i.url ? window.location = i.url : alert(i.errorcode)
            }).fail(function () {
                alert("订单提交出错！请稍后在试")
            }).always(function () {
                i._ajax_submit = !1, $("#btn_order", this).html("立即支付")
            })))) : (OT2.Util.alert("请阅读并同意《二一教育学币充值服务条款》", !0), !1)
        })
    }
};
Task.invoice = {
    data: {
        elec: 0,
        invoType: "",
        invoTitle: "",
        invoDuty: "",
        invoUser: "",
        invoEmail: "",
        invoMemo: "",
        invoPhone: "",
        invoSite: "",
        isFilled: 0
    }, init: function () {
        this.$el = $("#j-invoice"), this.events()
    }, validate_form: function (i) {
        var t = this;
        t.data.elec = $("#elec").hasClass("active") ? 1 : 0;
        var e = $(i), o = [];
        if (e.find("input[type=text]").each(function () {
            var i = this.name, e = $.trim(this.value), n = $(this).prev("label").html();
            if ($(this).hasClass("required")) {
                var a = "";
                t.data.elec ? (0 == e.length && "invoSite" != i && (a = n + " 不能为空！"), "invoEmail" != i || /^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(.[a-zA-Z0-9_-])+/.test(e) || a || (a = n + "格式不正确"), "invoPhone" != i || /^1[3578]\d{9}$/.test(e) || a || (a = n + "格式不正确")) : (0 == e.length && "invoEmail" != i && (a = n + " 不能为空！"), "invoPhone" != i || /^1[3578]\d{9}$/.test(e) || a || (a = n + "格式不正确")), a && o.push({
                    field: i,
                    msg: a
                })
            }
        }), 0 == o.length) return e.find("input[type=text]").each(function () {
            void 0 !== t.data[this.name] && (t.data[this.name] = this.value, t.data.elec ? t.data.invoType = "电子发票" : t.data.invoType = "纸质发票")
        }), !0;
        var n = "";
        return $.each(o, function (i, t) {
            n += t.msg + "\r\n"
        }), alert(n), !1
    }, toggleDetail: function (i) {
        var t = this, e = this.$el.find(".user-invoice");
        Task.count_total(), $("#invoice-pay")[i ? "show" : "hide"](), this.$el.find(".invo-txt").html(i ? "发票信息已填写" : "选择开具发票"), this.$el.find("#chk")[i ? "show" : "hide"](), i ? (e.find("div").each(function () {
            var i = this.id;
            this.innerHTML = "" == t.data[i] ? "未填" : t.data[i]
        }), e.show()) : e.hide()
    }, switch_form: function (i) {
        $(".modal-invoice")[i ? "show" : "hide"](), $(".modal-bg")[i ? "show" : "hide"]()
    }, events: function () {
        var i = this;
        this.$el.on("change", "#fapiao-checkbox", function () {
            Task.model.isinvoice = 0, i.toggleDetail(!1), this.checked && i.switch_form(!0)
        }), this.$el.on("click", "#chk", function () {
            i.switch_form(!0)
        }), $(".modal-invoice").on("submit", "form", function (t) {
            t.preventDefault(), i.validate_form(this) && (Task.model.isinvoice = 1, i.toggleDetail(!0), i.switch_form(!1))
        }), $(".modal-invoice").on("click", ".inv-close", function () {
            Task.model.isinvoice || i.$el.find("#fapiao-checkbox").prop("checked", !1), i.switch_form(!1)
        })
    }
};